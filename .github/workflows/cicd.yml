name: CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.2.0)'
        required: true
        type: string

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # ── Always runs ──────────────────────────────────────────
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck

      - name: Expo Doctor
        run: npx expo-doctor

  # ── Only on main push / manual dispatch ──────────────────
  version:
    name: Determine Version
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      number: ${{ steps.version.outputs.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Auto-increment: find latest tag, bump patch
            LATEST=$(git tag -l 'v*' --sort=-v:refname | head -n1)
            if [ -z "$LATEST" ]; then
              VERSION="1.0.0"
            else
              VERSION="${LATEST#v}"
              MAJOR=$(echo "$VERSION" | cut -d. -f1)
              MINOR=$(echo "$VERSION" | cut -d. -f2)
              PATCH=$(echo "$VERSION" | cut -d. -f3)
              PATCH=$((PATCH + 1))
              VERSION="${MAJOR}.${MINOR}.${PATCH}"
            fi
          fi
          echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "number=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Releasing: v${VERSION}"

  build:
    name: EAS Build
    if: github.event_name != 'pull_request'
    needs: [quality, version]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Update app version
        run: |
          VERSION="${{ needs.version.outputs.number }}"
          # Update package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          # Update app.json
          node -e "
            const fs = require('fs');
            const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            app.expo.version = '${VERSION}';
            fs.writeFileSync('app.json', JSON.stringify(app, null, 2) + '\n');
          "
          echo "Updated app version to ${VERSION}"

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android (preview)
        run: eas build --platform android --profile preview --non-interactive

      - name: Build Android (production - AAB for Google Play)
        run: eas build --platform android --profile production --non-interactive

  release:
    name: GitHub Release
    if: github.event_name != 'pull_request'
    needs: [version, quality, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Bump version in source
        run: |
          VERSION="${{ needs.version.outputs.number }}"
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          node -e "
            const fs = require('fs');
            const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            app.expo.version = '${VERSION}';
            fs.writeFileSync('app.json', JSON.stringify(app, null, 2) + '\n');
          "

      - name: Commit version bump & create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json app.json
          git diff --cached --quiet || git commit -m "chore: bump version to ${{ needs.version.outputs.number }} [skip ci]"
          git tag ${{ needs.version.outputs.tag }}
          git push origin main --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: "עגלה ${{ needs.version.outputs.number }}"
          generate_release_notes: true
